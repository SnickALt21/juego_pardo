<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pardo RPG - Telegram Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rpg-dark': '#1e293b',
                        'rpg-accent': '#3b82f6',
                        'rpg-inactive': '#475569',
                        'rpg-text': '#f8fafc',
                        'rpg-hp': '#ef4444',
                        'rpg-stat': '#34d399',
                        'rpg-gold': '#fbbf24',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .stat-bar { transition: width 0.3s ease-in-out; }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .pulse-glow { animation: pulse-glow 1.5s infinite; }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        .combat-text {
            position: absolute;
            animation: combat-float 1s ease-out forwards;
            font-weight: bold;
            font-size: 1.5rem;
            z-index: 100;
        }
        @keyframes combat-float {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-rpg-text min-h-screen p-2 sm:p-4">

    <!-- Navegaci√≥n -->
    <div class="max-w-7xl mx-auto mb-4 flex justify-between items-center bg-rpg-dark p-3 rounded-lg">
        <div class="flex space-x-4">
            <button onclick="showScreen('character')" class="px-4 py-2 bg-rpg-accent rounded-lg font-bold">Personaje</button>
            <button onclick="showScreen('missions')" class="px-4 py-2 bg-rpg-inactive hover:bg-rpg-accent rounded-lg font-bold" id="missions-tab">Misiones</button>
            <button onclick="showScreen('marketplace')" class="px-4 py-2 bg-rpg-inactive hover:bg-rpg-accent rounded-lg font-bold">Tienda</button>
            <button onclick="showScreen('pvp')" class="px-4 py-2 bg-rpg-inactive hover:bg-rpg-accent rounded-lg font-bold" id="pvp-tab">PVP</button>
        </div>
        <div class="flex items-center space-x-4 text-sm">
            <span class="text-rpg-gold">üí∞ <span id="gold-display">0</span> Oro</span>
            <span>Nv.<span id="level-display">1</span></span>
        </div>
    </div>

    <!-- Pantalla Principal: Personaje -->
    <div id="character-screen" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Columna 1: Stats -->
        <div class="bg-rpg-dark p-4 rounded-xl shadow-2xl space-y-4">
            <h2 class="text-xl font-bold text-rpg-accent border-b border-gray-700 pb-2">PERSONAJE</h2>
            <div class="flex justify-center mb-4">
                <img src="https://placehold.co/120x120/3b82f6/f8fafc?text=HEROE" class="rounded-full border-4 border-rpg-accent w-32 h-32">
            </div>
            <div class="space-y-2">
                <div class="flex justify-between"><span>Nivel:</span><span id="char-level">1</span></div>
                <div class="flex justify-between"><span>EXP:</span><span><span id="current-exp">0</span>/<span id="exp-needed">100</span></span></div>
                <div class="w-full bg-rpg-inactive rounded-full h-2">
                    <div id="exp-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="pt-2">
                <span class="text-sm font-medium">HP: <span id="char-hp-current">100</span> / <span id="char-hp-max">100</span></span>
                <div class="w-full bg-rpg-inactive rounded-full h-3 mt-1">
                    <div id="hp-bar" class="bg-rpg-hp h-3 rounded-full stat-bar" style="width: 100%"></div>
                </div>
            </div>
            <div id="stats-container" class="space-y-2 pt-4 border-t border-gray-700">
                <h3 class="font-bold text-rpg-stat">ATRIBUTOS</h3>
                <div class="flex justify-between"><span>Poder:</span><span id="stat-power">10</span></div>
                <div class="flex justify-between"><span>Destreza:</span><span id="stat-dexterity">10</span></div>
                <div class="flex justify-between"><span>Aguante:</span><span id="stat-endurance">10</span></div>
            </div>
        </div>

        <!-- Columna 2: Equipamiento -->
        <div class="bg-rpg-dark p-4 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold text-rpg-accent border-b border-gray-700 pb-2 mb-4">EQUIPAMIENTO</h2>
            <div id="gear-slots" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Columna 3: Asignaci√≥n de Puntos -->
        <div class="bg-rpg-dark p-4 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold text-rpg-accent border-b border-gray-700 pb-2 mb-4">PUNTOS</h2>
            <div class="bg-gray-800 p-3 rounded-lg mb-4">
                <h3 class="text-lg font-bold mb-3">Puntos: <span id="points-available" class="text-yellow-400">0</span></h3>
                <div id="allocation-ui" class="space-y-2"></div>
                <button onclick="confirmAllocation()" id="confirm-btn" class="w-full py-2 mt-3 bg-rpg-inactive rounded-lg font-bold" disabled>Confirmar</button>
            </div>
            <div id="app-message" class="p-2 text-center text-sm bg-gray-800 rounded"></div>
        </div>
    </div>

    <!-- Pantalla Misiones PVE -->
    <div id="missions-screen" class="hidden max-w-7xl mx-auto">
        <div class="bg-rpg-dark p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-rpg-accent mb-6">MISIONES (Nivel 1-10)</h2>
            <div id="missions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Pantalla Marketplace -->
    <div id="marketplace-screen" class="hidden max-w-7xl mx-auto">
        <div class="bg-rpg-dark p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-rpg-accent mb-4">MARKETPLACE</h2>
            <div class="flex space-x-2 mb-4 overflow-x-auto">
                <button onclick="filterMarketplace('all')" class="px-4 py-2 bg-rpg-accent rounded-lg whitespace-nowrap">Todos</button>
                <button onclick="filterMarketplace('Weapon')" class="px-4 py-2 bg-rpg-inactive rounded-lg whitespace-nowrap">Armas</button>
                <button onclick="filterMarketplace('Armor')" class="px-4 py-2 bg-rpg-inactive rounded-lg whitespace-nowrap">Armaduras</button>
                <button onclick="filterMarketplace('Helmet')" class="px-4 py-2 bg-rpg-inactive rounded-lg whitespace-nowrap">Cascos</button>
                <button onclick="filterMarketplace('Shield')" class="px-4 py-2 bg-rpg-inactive rounded-lg whitespace-nowrap">Escudos</button>
            </div>
            <div id="marketplace-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Pantalla PVP -->
    <div id="pvp-screen" class="hidden max-w-7xl mx-auto">
        <div class="bg-rpg-dark p-6 rounded-xl text-center">
            <h2 class="text-2xl font-bold text-rpg-accent mb-4">COMBATE PVP (Nivel 10+)</h2>
            <button onclick="joinPVPQueue()" id="pvp-join-btn" class="px-8 py-4 bg-yellow-500 hover:bg-yellow-600 rounded-lg font-bold text-2xl pulse-glow">BUSCAR BATALLA</button>
            <p id="pvp-status" class="mt-4 text-gray-400"></p>
        </div>
    </div>

    <!-- Modal de Combate -->
    <div id="combat-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center">
        <div class="bg-rpg-dark p-6 rounded-xl w-11/12 max-w-4xl relative">
            <div class="flex justify-between items-center mb-4">
                <div class="text-center flex-1">
                    <h3 class="font-bold text-xl mb-2" id="combat-player-name">T√ö</h3>
                    <div class="w-full bg-rpg-inactive rounded-full h-4">
                        <div id="combat-player-hp-bar" class="bg-rpg-hp h-4 rounded-full" style="width: 100%"></div>
                    </div>
                    <p id="combat-player-hp-text" class="text-sm mt-1">HP: 100/100</p>
                </div>
                <div class="mx-8 text-4xl">‚öîÔ∏è</div>
                <div class="text-center flex-1">
                    <h3 class="font-bold text-xl mb-2" id="combat-enemy-name">ENEMIGO</h3>
                    <div class="w-full bg-rpg-inactive rounded-full h-4">
                        <div id="combat-enemy-hp-bar" class="bg-rpg-hp h-4 rounded-full" style="width: 100%"></div>
                    </div>
                    <p id="combat-enemy-hp-text" class="text-sm mt-1">HP: 100/100</p>
                </div>
            </div>
            <div class="text-center mb-4">
                <p class="text-3xl font-bold" id="combat-timer">60</p>
                <p class="text-sm text-gray-400">Ronda <span id="combat-round">1</span>/3</p>
            </div>
            <div id="combat-log" class="bg-gray-800 p-4 rounded-lg h-40 overflow-y-auto mb-4 text-sm"></div>
            <div class="flex justify-center space-x-4">
                <button onclick="playerAttack()" id="attack-btn" class="px-8 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-xl">ATACAR</button>
                <button onclick="playerDefend()" id="defend-btn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-xl">DEFENDER</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (injected by Claude Artifact system)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth, userId = 'demo_user';
        
        // Backend Flask URL (MODIFICAR SEG√öN TU DEPLOY)
        const API_URL = 'http://localhost:5000';

        // Estado del juego
        let gameState = {
            level: 1,
            currentExp: 0,
            expToNextLevel: 100,
            gold: 0,
            currentHP: 100,
            maxHP: 100,
            pointsToAllocate: 0,
            stats: { power: 10, dexterity: 10, endurance: 10 },
            equipped: { Weapon: null, Shield: null, Boots: null, Gloves: null, Helmet: null, Armor: null, Amulet: null, Ring: null },
            inventory: [],
            statCache: {},
            pvpStats: { wins: 0, losses: 0 }
        };

        const levelLocks = { Weapon: 5, Shield: 10, Boots: 20, Gloves: 35, Helmet: 50, Armor: 60, Amulet: 70, Ring: 80 };

        // ==================== FIREBASE ====================
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) throw new Error("Firebase config missing");
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadCharacter();
                    } else {
                        renderUI();
                    }
                });
            } catch (error) {
                console.error("Firebase error:", error);
                showMessage("Error de conexi√≥n. Modo demo activado.");
                renderUI();
            }
        };

        const getCharacterRef = () => doc(db, `/artifacts/${appId}/users/${userId}/character_data/main`);

        const saveCharacter = async () => {
            if (!db || !userId) return;
            try {
                const toSave = { ...gameState };
                delete toSave.statCache;
                await setDoc(getCharacterRef(), toSave);
                showMessage("Progreso guardado");
            } catch (error) {
                console.error("Save error:", error);
            }
        };

        const loadCharacter = async () => {
            if (!db || !userId) return;
            try {
                const docSnap = await getDoc(getCharacterRef());
                if (docSnap.exists()) {
                    gameState = { ...gameState, ...docSnap.data(), statCache: {} };
                } else {
                    await saveCharacter();
                }
                renderUI();
            } catch (error) {
                console.error("Load error:", error);
                renderUI();
            }
        };

        // ==================== UI ====================
        window.showScreen = (screen) => {
            ['character', 'missions', 'marketplace', 'pvp'].forEach(s => {
                document.getElementById(`${s}-screen`).classList.toggle('hidden', s !== screen);
            });
            
            if (screen === 'missions') loadMissions();
            if (screen === 'marketplace') loadMarketplace();
        };

        const renderUI = () => {
            // Stats principales
            document.getElementById('char-level').textContent = gameState.level;
            document.getElementById('level-display').textContent = gameState.level;
            document.getElementById('gold-display').textContent = gameState.gold;
            document.getElementById('current-exp').textContent = gameState.currentExp;
            document.getElementById('exp-needed').textContent = gameState.expToNextLevel;
            document.getElementById('points-available').textContent = gameState.pointsToAllocate;
            
            // EXP Bar
            const expPercent = (gameState.currentExp / gameState.expToNextLevel) * 100;
            document.getElementById('exp-bar').style.width = `${expPercent}%`;
            
            // HP
            const finalStats = calculateFinalStats();
            gameState.maxHP = finalStats.maxHP;
            gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);
            
            document.getElementById('char-hp-current').textContent = gameState.currentHP;
            document.getElementById('char-hp-max').textContent = gameState.maxHP;
            const hpPercent = (gameState.currentHP / gameState.maxHP) * 100;
            document.getElementById('hp-bar').style.width = `${hpPercent}%`;
            
            // Stats
            document.getElementById('stat-power').textContent = finalStats.power;
            document.getElementById('stat-dexterity').textContent = finalStats.dexterity;
            document.getElementById('stat-endurance').textContent = finalStats.endurance;
            
            renderGearSlots();
            renderAllocationUI();
            updatePVPAccess();
        };

        const calculateFinalStats = () => {
            const stats = { ...gameState.stats };
            Object.values(gameState.equipped).forEach(item => {
                if (item) {
                    for (const stat in item.stats) {
                        stats[stat] = (stats[stat] || 0) + item.stats[stat];
                    }
                }
            });
            stats.maxHP = 100 + (gameState.level * 10) + (stats.endurance * 5);
            return stats;
        };

        const renderGearSlots = () => {
            const container = document.getElementById('gear-slots');
            container.innerHTML = Object.keys(levelLocks).map(slot => {
                const locked = gameState.level < levelLocks[slot];
                const item = gameState.equipped[slot];
                return `
                    <div class="p-3 rounded-lg ${locked ? 'bg-rpg-inactive opacity-60' : 'bg-gray-800 hover:bg-gray-700 cursor-pointer'}"
                         ${!locked ? `onclick="openGearModal('${slot}')"` : ''}>
                        <p class="font-bold text-sm ${locked ? 'text-gray-400' : 'text-rpg-accent'}">${slot}</p>
                        <p class="text-xs truncate">${locked ? `Nv.${levelLocks[slot]}` : (item ? item.name : 'VAC√çO')}</p>
                    </div>
                `;
            }).join('');
        };

        const renderAllocationUI = () => {
            const container = document.getElementById('allocation-ui');
            const tempStats = {};
            for (const key in gameState.stats) {
                tempStats[key] = gameState.stats[key] + (gameState.statCache[key] || 0);
            }
            
            container.innerHTML = ['power', 'dexterity', 'endurance'].map(stat => `
                <div class="flex justify-between items-center">
                    <span class="capitalize">${stat}: <span class="text-rpg-stat">${tempStats[stat]}</span></span>
                    <div class="flex space-x-2">
                        <button onclick="adjustStat('${stat}', -1)" class="px-3 py-1 bg-red-600 rounded">-</button>
                        <button onclick="adjustStat('${stat}', 1)" class="px-3 py-1 bg-green-600 rounded" ${gameState.pointsToAllocate > 0 ? '' : 'disabled'}>+</button>
                    </div>
                </div>
            `).join('');
            
            const hasChanges = Object.values(gameState.statCache).some(v => v > 0);
            document.getElementById('confirm-btn').disabled = !hasChanges;
            document.getElementById('confirm-btn').classList.toggle('bg-rpg-accent', hasChanges);
            document.getElementById('confirm-btn').classList.toggle('bg-rpg-inactive', !hasChanges);
        };

        window.adjustStat = (stat, delta) => {
            if (delta > 0 && gameState.pointsToAllocate <= 0) return;
            if (delta < 0 && (gameState.statCache[stat] || 0) <= 0) return;
            
            gameState.pointsToAllocate -= delta;
            gameState.statCache[stat] = (gameState.statCache[stat] || 0) + delta;
            renderAllocationUI();
            document.getElementById('points-available').textContent = gameState.pointsToAllocate;
        };

        window.confirmAllocation = () => {
            for (const stat in gameState.statCache) {
                gameState.stats[stat] += gameState.statCache[stat];
            }
            gameState.statCache = {};
            renderUI();
            saveCharacter();
            showMessage("¬°Puntos asignados!");
        };

        const updatePVPAccess = () => {
            const pvpTab = document.getElementById('pvp-tab');
            const pvpBtn = document.getElementById('pvp-join-btn');
            const pvpStatus = document.getElementById('pvp-status');
            
            if (gameState.level >= 10) {
                pvpTab.classList.remove('opacity-50');
                pvpBtn.disabled = false;
                pvpStatus.textContent = "¬°Listo para el combate!";
            } else {
                pvpTab.classList.add('opacity-50');
                pvpBtn.disabled = true;
                pvpStatus.textContent = `Nivel requerido: 10 (Actual: ${gameState.level})`;
            }
        };

        // ==================== MISIONES PVE ====================
        const loadMissions = () => {
            const container = document.getElementById('missions-list');
            const missions = [
                { id: 1, name: "Rata Salvaje", level: 1 },
                { id: 2, name: "Lobo Hambriento", level: 2 },
                { id: 3, name: "Goblin Ladr√≥n", level: 3 },
                { id: 4, name: "Orco Guerrero", level: 4 },
                { id: 5, name: "Troll de Piedra", level: 5 },
                { id: 6, name: "Ara√±a Gigante", level: 6 },
                { id: 7, name: "Caballero Oscuro", level: 7 },
                { id: 8, name: "Demonio Menor", level: 8 },
                { id: 9, name: "Drag√≥n Joven", level: 9 },
                { id: 10, name: "Se√±or Oscuro", level: 10 }
            ];
            
            container.innerHTML = missions.map(m => `
                <div class="bg-gray-800 p-4 rounded-lg ${gameState.level < m.level ? 'opacity-50' : 'hover:bg-gray-700 cursor-pointer'}"
                     ${gameState.level >= m.level ? `onclick="startMission(${m.id})"` : ''}>
                    <h3 class="font-bold text-lg">${m.name}</h3>
                    <p class="text-sm text-gray-400">Nivel recomendado: ${m.level}</p>
                    <button class="mt-2 px-4 py-2 bg-rpg-accent rounded-lg w-full font-bold" ${gameState.level < m.level ? 'disabled' : ''}>
                        ${gameState.level < m.level ? 'BLOQUEADO' : 'INICIAR'}
                    </button>
                </div>
            `).join('');
        };

        window.startMission = async (missionId) => {
            // Restaurar HP al 100%
            gameState.currentHP = gameState.maxHP;
            renderUI();
            
            try {
                const response = await fetch(`${API_URL}/api/pve/mission/${missionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_stats: calculateFinalStats() })
                });
                const data = await response.json();
                startCombat(data.enemy, 'pve', missionId);
            } catch (error) {
                console.error("Error starting mission:", error);
                showMessage("Error al iniciar misi√≥n");
            }
        };

        // ==================== COMBATE ====================
        let combatState = null;

        const startCombat = (enemy, type, missionId = null) => {
            const playerStats = calculateFinalStats();
            combatState = {
                type,
                missionId,
                player: { hp: gameState.currentHP, maxHP: gameState.maxHP, stats: playerStats },
                enemy: { hp: enemy.hp, maxHP: enemy.hp, stats: enemy },
                round: 1,
                playerWins: 0,
                enemyWins: 0,
                timer: 60,
                playerDefending: false
            };
            
            document.getElementById('combat-modal').classList.remove('hidden');
            document.getElementById('combat-player-name').textContent = "T√ö";
            document.getElementById('combat-enemy-name').textContent = enemy.name;
            updateCombatUI();
            startCombatTimer();
        };

        const updateCombatUI = () => {
            const { player, enemy, round } = combatState;
            
            document.getElementById('combat-player-hp-text').textContent = `HP: ${player.hp}/${player.maxHP}`;
            document.getElementById('combat-enemy-hp-text').textContent = `HP: ${enemy.hp}/${enemy.maxHP}`;
            document.getElementById('combat-round').textContent = round;
            
            const playerHPPercent = (player.hp / player.maxHP) * 100;
            const enemyHPPercent = (enemy.hp / enemy.maxHP) * 100;
            
            document.getElementById('combat-player-hp-bar').style.width = `${playerHPPercent}%`;
            document.getElementById('combat-enemy-hp-bar').style.width = `${enemyHPPercent}%`;
        };

        const startCombatTimer = () => {
            const timerInterval = setInterval(() => {
                combatState.timer--;
                document.getElementById('combat-timer').textContent = combatState.timer;
                
                if (combatState.timer <= 0) {
                    clearInterval(timerInterval);
                    endRound();
                }
            }, 1000);
        };

        window.playerAttack = async () => {
            if (!combatState) return;
            
            try {
                const response = await fetch(`${API_URL}/api/pve/attack`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        attacker: combatState.player.stats,
                        defender: combatState.enemy.stats
                    })
                });
                const result = await response.json();
                
                if (result.hit) {
                    combatState.enemy.hp -= result.damage;
                    logCombat(`Atacas: ${result.message}`, 'player');
                } else {
                    logCombat(result.message, 'player');
                }
                
                updateCombatUI();
                
                if (combatState.enemy.hp <= 0) {
                    endRound(true);
                } else {
                    setTimeout(enemyTurn, 1000);
                }
            } catch (error) {
                console.error("Attack error:", error);
            }
        };

        window.playerDefend = () => {
            combatState.playerDefending = true;
            logCombat("Te preparas para defender...", 'player');
            setTimeout(enemyTurn, 1000);
        };

        const enemyTurn = async () => {
            if (!combatState) return;
            
            try {
                const defenderStats = combatState.playerDefending 
                    ? { ...combatState.player.stats, endurance: combatState.player.stats.endurance * 2 }
                    : combatState.player.stats;
                
                const response = await fetch(`${API_URL}/api/pve/attack`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        attacker: combatState.enemy.stats,
                        defender: defenderStats
                    })
                });
                const result = await response.json();
                
                if (result.hit) {
                    const finalDamage = combatState.playerDefending ? Math.floor(result.damage / 2) : result.damage;
                    combatState.player.hp -= finalDamage;
                    logCombat(`Enemigo ataca: ${finalDamage} de da√±o${combatState.playerDefending ? ' (DEFENDIDO)' : ''}`, 'enemy');
                } else {
                    logCombat("El enemigo falla su ataque", 'enemy');
                }
                
                combatState.playerDefending = false;
                updateCombatUI();
                
                if (combatState.player.hp <= 0) {
                    endRound(false);
                }
            } catch (error) {
                console.error("Enemy attack error:", error);
            }
        };

        const endRound = (playerWon = null) => {
            if (playerWon === null) {
                // Time over - el que tenga m√°s HP gana
                playerWon = combatState.player.hp > combatState.enemy.hp;
            }
            
            if (playerWon) {
                combatState.playerWins++;
                logCombat("¬°Ganaste la ronda!", 'system');
            } else {
                combatState.enemyWins++;
                logCombat("Perdiste la ronda", 'system');
            }
            
            // Verificar victoria final (2 de 3)
            if (combatState.playerWins >= 2) {
                endCombat(true);
            } else if (combatState.enemyWins >= 2) {
                endCombat(false);
            } else {
                // Siguiente ronda
                combatState.round++;
                combatState.timer = 60;
                combatState.player.hp = combatState.player.maxHP;
                combatState.enemy.hp = combatState.enemy.maxHP;
                updateCombatUI();
                startCombatTimer();
            }
        };

        const endCombat = async (victory) => {
            if (combatState.type === 'pve') {
                try {
                    const response = await fetch(`${API_URL}/api/pve/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mission_id: combatState.missionId,
                            user_id: userId,
                            victory
                        })
                    });
                    const data = await response.json();
                    
                    gameState.currentExp += data.exp;
                    gameState.gold += data.gold;
                    
                    if (data.item) {
                        gameState.inventory.push(data.item);
                        showMessage(`¬°Item conseguido: ${data.item.name}!`);
                    }
                    
                    // Verificar subida de nivel
                    while (gameState.currentExp >= gameState.expToNextLevel) {
                        levelUp();
                    }
                    
                    renderUI();
                    saveCharacter();
                } catch (error) {
                    console.error("Complete mission error:", error);
                }
            }
            
            logCombat(victory ? "¬°VICTORIA TOTAL!" : "DERROTA", 'system');
            
            setTimeout(() => {
                document.getElementById('combat-modal').classList.add('hidden');
                combatState = null;
            }, 3000);
        };

        const logCombat = (message, type) => {
            const log = document.getElementById('combat-log');
            const color = type === 'player' ? 'text-green-400' : type === 'enemy' ? 'text-red-400' : 'text-yellow-400';
            log.innerHTML += `<p class="${color}">${message}</p>`;
            log.scrollTop = log.scrollHeight;
        };

        const levelUp = () => {
            gameState.level++;
            gameState.currentExp -= gameState.expToNextLevel;
            gameState.expToNextLevel = Math.floor(100 * Math.pow(gameState.level, 1.5));
            gameState.pointsToAllocate += 5;
            
            // +10 HP fijos por nivel
            gameState.maxHP += 10;
            gameState.currentHP = gameState.maxHP; // Restaurar HP al subir de nivel
            
            showMessage(`¬°NIVEL ${gameState.level}! +5 puntos, +10 HP m√°ximo`);
        };

        // ==================== MARKETPLACE ====================
        let marketplaceData = {};

        const loadMarketplace = async () => {
            try {
                const response = await fetch(`${API_URL}/api/marketplace/items`);
                marketplaceData = await response.json();
                filterMarketplace('all');
            } catch (error) {
                console.error("Marketplace error:", error);
                showMessage("Error al cargar tienda");
            }
        };

        window.filterMarketplace = (type) => {
            const container = document.getElementById('marketplace-items');
            let items = [];
            
            if (type === 'all') {
                items = Object.values(marketplaceData).flat();
            } else {
                items = marketplaceData[type] || [];
            }
            
            // Ordenar por nivel (bajo a alto)
            items.sort((a, b) => a.level - b.level);
            
            container.innerHTML = items.map(item => {
                const canAfford = gameState.gold >= item.price;
                const canEquip = gameState.level >= item.level;
                const statsText = Object.entries(item.stats).map(([k, v]) => `+${v} ${k}`).join(', ');
                
                return `
                    <div class="bg-gray-800 p-4 rounded-lg ${canAfford && canEquip ? 'hover:bg-gray-700' : 'opacity-60'}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg">${item.name}</h3>
                            <span class="text-xs bg-${item.rarity === 'Legendario' ? 'yellow' : item.rarity === '√âpico' ? 'purple' : item.rarity === 'Raro' ? 'blue' : 'gray'}-600 px-2 py-1 rounded">${item.rarity}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${statsText}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-rpg-gold font-bold">üí∞ ${item.price}</span>
                            <button onclick='buyItem(${JSON.stringify(item)})' 
                                    class="px-4 py-2 rounded-lg font-bold ${canAfford && canEquip ? 'bg-rpg-accent hover:bg-blue-600' : 'bg-rpg-inactive cursor-not-allowed'}"
                                    ${canAfford && canEquip ? '' : 'disabled'}>
                                ${!canEquip ? `Nv.${item.level}` : !canAfford ? 'Sin oro' : 'COMPRAR'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.buyItem = (item) => {
            if (gameState.gold < item.price) {
                showMessage("Oro insuficiente");
                return;
            }
            if (gameState.level < item.level) {
                showMessage(`Nivel ${item.level} requerido`);
                return;
            }
            
            gameState.gold -= item.price;
            gameState.inventory.push(item);
            showMessage(`¬°${item.name} comprado!`);
            renderUI();
            saveCharacter();
            filterMarketplace('all'); // Refrescar vista
        };

        window.openGearModal = (slot) => {
            // Filtrar items del inventario que pueden ir en este slot
            const availableItems = gameState.inventory.filter(item => 
                item.type === slot && item.level <= gameState.level
            );
            
            if (availableItems.length === 0) {
                showMessage(`No tienes ${slot} disponibles. Visita el Marketplace.`);
                return;
            }
            
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center" id="gear-modal">
                    <div class="bg-rpg-dark p-6 rounded-xl w-11/12 max-w-md">
                        <h3 class="text-xl font-bold mb-4">Equipar ${slot}</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${availableItems.map((item, idx) => {
                                const statsText = Object.entries(item.stats).map(([k, v]) => `+${v} ${k}`).join(', ');
                                return `
                                    <div class="bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer" 
                                         onclick="equipItem('${slot}', ${idx})">
                                        <p class="font-bold">${item.name}</p>
                                        <p class="text-sm text-gray-300">${statsText}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="closeGearModal()" class="w-full mt-4 py-2 bg-rpg-accent rounded-lg">Cerrar</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };

        window.equipItem = (slot, itemIndex) => {
            const availableItems = gameState.inventory.filter(item => 
                item.type === slot && item.level <= gameState.level
            );
            
            const item = availableItems[itemIndex];
            
            // Si hay algo equipado, devolverlo al inventario
            if (gameState.equipped[slot]) {
                gameState.inventory.push(gameState.equipped[slot]);
            }
            
            // Equipar el nuevo item y quitarlo del inventario
            gameState.equipped[slot] = item;
            const invIndex = gameState.inventory.findIndex(i => 
                i.name === item.name && i.type === item.type
            );
            if (invIndex !== -1) {
                gameState.inventory.splice(invIndex, 1);
            }
            
            showMessage(`¬°${item.name} equipado!`);
            closeGearModal();
            renderUI();
            saveCharacter();
        };

        window.closeGearModal = () => {
            const modal = document.getElementById('gear-modal');
            if (modal) modal.remove();
        };

        // ==================== PVP ====================
        let pvpSearchInterval = null;

        window.joinPVPQueue = async () => {
            if (gameState.level < 10) {
                showMessage("Nivel 10 requerido para PVP");
                return;
            }
            
            // Restaurar HP al 100% antes de buscar batalla
            gameState.currentHP = gameState.maxHP;
            renderUI();
            
            const btn = document.getElementById('pvp-join-btn');
            btn.disabled = true;
            btn.textContent = "BUSCANDO...";
            
            try {
                pvpSearchInterval = setInterval(async () => {
                    const response = await fetch(`${API_URL}/api/pvp/join_queue`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            level: gameState.level,
                            stats: calculateFinalStats()
                        })
                    });
                    const data = await response.json();
                    
                    if (data.match_found) {
                        clearInterval(pvpSearchInterval);
                        btn.disabled = false;
                        btn.textContent = "BUSCAR BATALLA";
                        
                        // Iniciar combate PVP
                        startCombat({
                            name: `Jugador Nv.${data.opponent.level}`,
                            hp: data.opponent.stats.maxHP,
                            power: data.opponent.stats.power,
                            dexterity: data.opponent.stats.dexterity,
                            endurance: data.opponent.stats.endurance
                        }, 'pvp');
                    }
                }, 3000); // Buscar cada 3 segundos
                
                // Timeout de 30 segundos
                setTimeout(() => {
                    if (pvpSearchInterval) {
                        clearInterval(pvpSearchInterval);
                        btn.disabled = false;
                        btn.textContent = "BUSCAR BATALLA";
                        showMessage("No se encontr√≥ oponente. Intenta de nuevo.");
                    }
                }, 30000);
                
            } catch (error) {
                console.error("PVP queue error:", error);
                clearInterval(pvpSearchInterval);
                btn.disabled = false;
                btn.textContent = "BUSCAR BATALLA";
                showMessage("Error al buscar batalla");
            }
        };

        // ==================== UTILIDADES ====================
        const showMessage = (msg) => {
            const msgEl = document.getElementById('app-message');
            msgEl.textContent = msg;
            msgEl.classList.add('bg-rpg-accent');
            setTimeout(() => msgEl.classList.remove('bg-rpg-accent'), 3000);
        };

        // Auto-guardado cada 30 segundos
        setInterval(() => {
            if (userId !== 'demo_user') saveCharacter();
        }, 30000);

        // ==================== INICIALIZACI√ìN ====================
        initFirebase();
    </script>
</body>
</html>
